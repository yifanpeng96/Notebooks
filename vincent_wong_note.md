# 自动驾驶决策规划算法笔记 - 忠厚老实的老王
## 总纲
* 自动驾驶六个级别.\
L0: 没有任何自动驾驶功能的车.\
L1: 有横向和纵向的自动驾驶功能, 但是横纵向没有办法联合作用, 也就是说开了横向就不能开纵向, 开了纵向就不能开横向.\
L2: 横纵向可以联合作用, 但是驾驶员必须对驾驶所发生的一切情况负责.\
L3: 功能与L2基本相同, 最大的区别在于责任, 对一部分场景驾驶员不必负责.\
L4: 大部分道路都可以自动驾驶, 大部分场景都不需要驾驶员负责.\
L5: 完全的自动驾驶.
* 区分这些等级的第一个关键因素是功能, 第二个是责任. 从L0到L2主要是功能区分, 从L3到L5主要是责任区分.
* 决策规划算法模块一分为三: 导航规划算法, 行为规划算法(决策算法), 运动规划算法.
* 导航规划算法将计算出大体上a到b的最优路径. 此算法和机器人导航、手机导航的算法基本是一致的, 长度在几公里到几百公里不等. 该算法是整个规划模块中最为成熟的算法. 这个算法的特点是会给一个粗略的大范围的路径, 但是这个路径不会去考虑如何去避障, 也不会考虑车辆动力学的约束, 所以说一般它规划出来的路径是不规则的. 导航算法一般来说只需要执行一次就可以了, 只有遇到大范围的拥堵, 施工, 偏航情况下, 才会再次执行.
* 决策算法是决定车辆行驶意图的算法. 对于静态障碍物, 到底往左绕还是往右绕, 对于动态障碍物到底是该减速避让还是该加速超车? 该算法决定了车辆的行驶意图, 这也是整个规划算法中最难做的部分. 决策算法的特点是它会给一个车辆的行驶意图, 会指导车辆到底该避让还是该超车, 该左转还是往右转, 但是决策并不会给出具体的运动建议, 例如往左转多少度, 或者车辆加减速到多少. 由于实际的环境是瞬息万变的, 所以决策算法需要有较高的执行频率, 一般来说是10Hz. 决策算法也需要有一定的稳定性, 不允许出现在周围环境比较稳定的情况下, 出现朝令夕改的现象, 除非环境发生了变化, 比如说看到障碍物了, 比如说有个直道变成弯道了, 不然会导致这个控制这个效果会变得非常差.
* 运动规划算法是根据决策给出的行为意图, 在相关的时空中搜索出或者说优化出一条具有详细路径速度信息, 并且满足各个约束条件的轨迹, 并将这个轨迹发给控制模块去跟踪. 这个轨迹的长度一般在几米到几十米不等. 运动规划算法的特点是生成的轨迹是整个规划模块最终的输出, 具有详细的路径和速度的信息, 而且它的执行频率与决策的频率相同, 都是10Hz. 同样, 运动规划也需要有一定的稳定性, 在环境不发生剧烈变动的情况下, 规划的轨迹要基本一致.
* 这个系列的教学将详细地讲解决策算法与运动规划算法, 不讲导航算法, 因为导航算法相对来说比较成熟. 以`Apollo EM Planner`为例, EM Planner擅长处理复杂环境下的决策规划问题, 也是Apollo默认的决策规划算法.

## 五次多项式
* 在车辆的运动规划中, 一个非常重要的指标就是舒适性, 在物理中, 衡量舒适性的物理量叫$jerk = da/dt$. jerk的绝对值越小, 意味着a的变化越平缓, 也就意味着越舒适.
* 五次多项式是带约束的泛函$\int_0^T{f^{'''}}^2dt$取极值的解函数, 所以五次多项式在规划中特别常见, 比如说两个离散点的这个轨迹点一般都是用五次多项式连接.

## 凸优化与非凸优化
* 最优轨迹的指标: 平滑性，舒适性，尽可能的短，耗时少. 约束是轨迹要连续.
* 衡量轨迹质量是往往用cost function表示. 若$f(t)=a_0+a_1t+\cdots+a_5t^5$, 则代价可定为$J=w_1{f^{'}}^2+w_2{f^{''}}^2+w_3{f^{'''}}^2$. $J$越小, 越平滑.
* 求解高维复杂约束下的复杂函数的最小值的难点在于: 极值点很多, 难以快速计算; 约束复杂, 是许多不连续的小区间之并, 处理较繁. 一般采用迭代法, 按照梯度的反方向迭代, 包括牛顿法, 梯度下降法, 高斯牛顿法.
* 迭代法的优点在于比求导法快很多, 在自动驾驶里计算速度是一个很重要的指标.
* 迭代法的缺点在于对初值敏感, 可能会收敛到局部极小值.
* 凸优化必有的2个性质: 凸函数和凸空间.
* 凸函数: cost function只有一个极值点, 且为极小值.
* 凸空间: 约束空间的一块完整, 不破碎的空间.
* 为什么是凸优化? 因为凸优化是最简单的非线性的规划方法，也是我们至少在2021年来说唯一掌握的，唯一的研究的比较明白、比较彻底的一种非线性的优化方法。凸优化是所有复杂的优化方法的基石，很多非凸问题都是想办法去转化成凸问题，然后去求凸优化的解。主要思路是找这个非凸问题中的凸结构.
* 自动驾驶中的避障约束空间(包括静态和动态避障)不是一个凸空间.
* 非凸空间->离散化->粗解->迭代->最终解. 缺点: 采样点较少的话, 导致最优解不在采样的凸空间里，会收敛到局部最优; 采样点较多的话, 会导致维度灾难.

## Frenet坐标系与Cartesian坐标系的转换
* 龙格现象: 高次多项式拟合可能会出现震荡. 一般来说，对一些大量的点进行拟合都是用分段的低次多样式.
* 曲线坐标系与直角坐标系的区别:\
基向量一般不是常向量.\
点的曲线坐标变化与点的实际位移一般不一致.

## 参考线模块
* 